# Festival ‚Äì Pack de READMEs par app (sp√©cifications d√©taill√©es & ambitieuses)

> **Objet** : Sp√©cifier **les attentes d√©taill√©es** (fonctionnelles & non‚Äëfonctionnelles) pour chaque app du backend. Chaque section int√®gre la **Roadmap transverse V2+** directement dans les objectifs, avec crit√®res d‚Äôacceptation, API, s√©curit√©, validation, observabilit√©, webhooks, i18n, cache, tests et performance.
>
> **Convention d‚ÄôAPI** : pr√©fixe `/api/` (ex. `/api/cms/pages/`). R√©ponses JSON UTF‚Äë8. Dates/Heures en ISO‚Äë8601. Fuseau par d√©faut **Europe/Paris**.

---

## üî≠ Architecture & conventions communes

### API & formats

* **Pagination** : DRF limit/offset (`?limit=50&offset=0`) + `page_size` max 200 ; exposer `count`, `next`, `previous`, `results`.
* **Recherche** : `?search=` plein‚Äëtexte sur champs d√©clar√©s ; **exactitude** non garantie, tri secondaire d√©terministe (cl√© primaire croissante).
* **Tri** : `?ordering=field` ou `?ordering=-field` ; multiples autoris√©s `?ordering=-publish_at,slug`.
* **Filtres** : exclusivement sur `filterset_fields` ; plusieurs valeurs via r√©p√©tition `?tags=annonce&tags=lineup`.
* **Sch√©ma d‚Äôerreur** (uniforme) :

```json
{
  "request_id": "uuid",
  "detail": "Human readable error",
  "code": "ERROR_CODE",
  "field_errors": {"field": ["message1", "message2"]}
}
```

* **Idempotence** : POST non idempotent ; PUT/PATCH idempotent par `id`.
* **Version d‚ÄôAPI** (Roadmap) : header `X-API-Version: 1`. D√©pr√©ciations via `Sunset` + `Link: rel="deprecation"`.

### S√©curit√©

* **Auth** : Token (SimpleJWT) ou session ; endpoints publics en lecture pour contenu publi√©.
* **RBAC transverse** (permissions DRF) :

  * `viewer` : lecture publique (contenu publi√©, line‚Äëup, slots confirm√©s, sponsors visibles, tickets en vente).
  * `editor` : CRUD CMS & contenu non publi√© ; scope d‚Äô√©dition par **√©dition**.
  * `booker` : CRUD lineup/schedule.
  * `sponsor_manager` : CRUD sponsors/sponsorships.
  * `ticket_manager` : CRUD ticket types.
  * `admin` : super‚Äëpermissions.
* **OWASP** : escape/sanitize de toutes rendus HTML (CMS Markdown) ; anti‚ÄëCSRF pour sessions ; rate‚Äëlimit (voir plus bas).
* **Audits** (Roadmap) : audit trail (Django‚ÄëSimple‚ÄëHistory) activ√© sur entit√©s cl√©s ; export CSV.

### Performance & SLO

* **SLO API** (lectures) : P95 ‚â§ 300 ms (cache) / P95 ‚â§ 600 ms (non‚Äëcache) ; P99 ‚â§ 1 s.
* **SLO API** (√©critures) : P95 ‚â§ 800 ms, P99 ‚â§ 2 s.
* **Capacit√©** cible : 150 req/s en lecture, 20 req/s en √©criture sur infra standard (1 app + 1 DB + Redis cache).
* **Payload** : 1 Mo max par r√©ponse (`413` sinon). Pagination obligatoire au‚Äëdel√†.

### Cache & invalidation

* **Layer** : Redis + CDN (Roadmap). TTL par ressource :

  * CMS public (pages/news publi√©es) : TTL 300s ; purge sur `post_save`/`post_delete`.
  * Schedule `?day=...` : TTL 120s ; purge sur modification de slot du jour.
  * Lineup `artists?ordering=-popularity` : TTL 300s.
* **Cache headers** : `ETag`, `Last‚ÄëModified` ; 304 si inchang√©.

### Observabilit√©

* **Logs structur√©s** (JSON) avec `request_id`, `user_id`, `role`, `latency_ms`, `status_code`.
* **Metrics Prometheus** (exemples) :

  * `http_requests_total{route,method,status}`
  * `http_request_duration_seconds_bucket{route}`
  * `cms_published_entities_total{type}`
  * `schedule_slots_status_total{status}`
  * `tickets_on_sale_total`
* **Tracing** (Roadmap) : OpenTelemetry (OTLP) avec spans DB/Redis.

### Webhooks (transverse)

* **Signature** : `X-Signature-SHA256` = HMAC(body, secret). Retry avec backoff jusqu‚Äô√† 24h.
* **√âv√©nements** (noms canoniques) :

  * `cms.page.published`, `cms.news.published`, `cms.page.unpublished`
  * `schedule.slot.created|updated|canceled`
  * `lineup.artist.created|updated`
  * `tickets.type.sale_opened|sale_closed`
  * `core.edition.activated`
* **Payload** :

```json
{
  "id": "uuid",
  "type": "schedule.slot.updated",
  "occurred_at": "2025-09-08T08:20:00+02:00",
  "version": "1.0",
  "data": { "slot_id": 123, "changes": {"status": ["tentative","confirmed"]} }
}
```

### i18n & accessibilit√©

* **Phase 1** : FR ; **Phase 2** : FR/EN (Roadmap) via champs localis√©s dans CMS.
* **A11y** : textes alternatifs obligatoires pour images (cover, logos) c√¥t√© CMS.

### Qualit√© & tests

* **Couverture** : ‚â• 85% par app.
* **Pyramide** : unitaires (mod√®les/validators) > int√©gration (viewsets/permissions) > E2E (sc√©narios cl√©s).
* **Fixtures** nomm√©es : `core.editions.json`, `cms.pages.json`, etc.
* **CI** : `migrations --check`, `flake8`, `isort`, `mypy` (Roadmap), `pytest -q`.

---

## üì¶ apps/common

### 1) Objectifs (incl. Roadmap)

* Offrir des **abstractions solides** (time, slug, publish, address) r√©utilisables.
* **SoftDelete** & **Versioning** (Roadmap) pour historiser et restaurer.
* **Webhooks transverses** sur √©v√©nements structurants (suppression logique, changements de statut de publication).
* **Internationalisation** des adresses (normalisation, geohash ‚Äì Roadmap).

### 2) Exigences fonctionnelles

* `SluggedModel` g√©n√®re automatiquement le slug si absent ; collisions ‚Üí suffixe court unique.
* `PublishableModel` tol√®re `publish_at/unpublish_at` vides ; validation (Roadmap) : `publish_at < unpublish_at` si les deux d√©finis.

### 3) Exigences non‚Äëfonctionnelles

* Aucun endpoint direct expos√© ; code 100% abstrait ; documentation par docstrings.

### 4) Tests attendus

* G√©n√©ration de slug multi‚Äëlangue ; longueur max 220.
* S√©rialisation d‚Äôadresses avec caract√®res sp√©ciaux.

---

## üß± apps/core

### 1) Objectifs (incl. Roadmap)

* √ätre la **source de v√©rit√©** des √âditions, Lieux, Sc√®nes, Contacts.
* **Activation unique** d‚Äôune √©dition √† la fois (Roadmap : contrainte applicative + migration data).
* **Endpoint r√©sum√©** `/editions/{id}/summary` (Roadmap) pour KPIs : nb stages, nb slots par status, nb news publi√©es, nb sponsors visibles, types de tickets en vente.
* **Webhooks** : `core.edition.activated`.

### 2) Exigences fonctionnelles

* `FestivalEdition`

  * `year` unique ; `start_date ‚â§ end_date` (validator).
  * `is_active` : passer √† `true` doit **d√©sactiver** les autres √©ditions (Roadmap : transaction + signal).
* `Stage` : `(edition, name)` unique.
* `Contact` : `(edition, type, label)` unique.

### 3) API

* `GET /api/core/editions/?year=&is_active=` ; `search=name,tagline` ; `ordering=year,start_date,created_at` (def `-year`).
* `GET /api/core/stages/?edition=&venue=&covered=` ; `search=name,venue__name`.
* **Summary (Roadmap)** : `GET /api/core/editions/{id}/summary` ‚Üí

```json
{
  "edition": {"id": 1, "year": 2025},
  "stages": 5,
  "slots": {"total": 42, "confirmed": 30, "canceled": 2},
  "news_published": 10,
  "sponsors_visible": 14,
  "tickets_on_sale": 6
}
```

### 4) Permissions

* `viewer` lecture ; `editor` CRUD scind√© par √©dition ; `admin` total.

### 5) Observabilit√© & Cache

* Invalidation sur `is_active` ; m√©trique `core_active_edition{year}`.

### 6) Tests

* Activation unique ; int√©grit√© `(edition,name)` ; validation dates.

---

## üë§ apps/authx

### 1) Objectifs (incl. Roadmap)

* Centraliser les **profils** (display\_name, avatar, preferences).
* **Consentements RGPD** (Roadmap) : structure `consents` horodat√©e.
* **SSO/OIDC** (Roadmap) : hydratation `UserProfile` via claims (email, name, picture, locale).
* **Webhooks** : `authx.profile.updated` pour CRM/marketing.

### 2) Exigences fonctionnelles

* Champ `preferences` JSON sch√©m√© (doc JSONSchema ‚Äì Roadmap) :

  * `default_filters`: `{edition, stages:[], genres:[], only_published:true}`
  * `ui`: `{theme:"dark"|"light"}`
* **Self‚Äëservice** : un utilisateur ne modifie **que son** profil.

### 3) API

* `GET /api/authx/profiles/?search=` (admin) ; `PATCH /api/authx/profiles/{id}/` (owner/admin).

### 4) Permissions & S√©curit√©

* Contr√¥le ownership object‚Äëlevel ; tests syst√©matiques.
* Taille `preferences` ‚â§ 32 Ko.

### 5) Observabilit√©

* Metric `authx_profile_updates_total` ; log anonymis√© des cl√©s modifi√©es.

### 6) Tests

* Lecture/√©criture par propri√©taire ; refus si autre user (`403`).

---

## üì∞ apps/cms

### 1) Objectifs (incl. Roadmap)

* G√©rer Pages/FAQ/News par √©dition avec publication.
* **Pr√©visualisation s√©curis√©e** (`/preview`) via token temporel (15 min) ‚Äì sans indexation.
* **Versioning & diff** des Markdown (Roadmap) ; rollback.
* **SEO** : sitemap par √©dition, balises `og:*`/`twitter:*` aliment√©es par `meta`.
* **Webhooks** : `cms.page.published`, `cms.news.published`.

### 2) Exigences fonctionnelles

* Un contenu **non publi√©** n‚Äôest **jamais** expos√© aux endpoints publics (filtre automatique c√¥t√© ViewSet public ‚Äì Roadmap : ViewSet Public distinct).
* Rendu Markdown ‚Üí HTML **sanitiz√©** (bleach) ; **liste blanche** de balises (`p, h1..h3, a, ul, ol, li, em, strong, img(alt,src), blockquote, code, pre`).
* `Page` : `(edition, slug)` unique ; `slug` kebab‚Äëcase.
* `News.tags` : tableau de cha√Ænes ; filtre multiple.

### 3) API

* `GET /api/cms/pages/?edition=&status=&search=&ordering=`.
* `GET /api/cms/news/?edition=&status=&tags=&search=&ordering=-publish_at`.
* **Preview** : `POST /api/cms/preview/` ‚Üí body `{type:"page|news", id:123}` ‚áí URL pr√©‚Äësign√©e (Roadmap).

### 4) Cache & Performance

* TTL 300s ; purge cibl√©e par `edition` & `slug`/`id`.

### 5) Observabilit√©

* `cms_published_entities_total{type}` ; `cms_preview_requests_total`.

### 6) Tests

* Interdiction d‚Äôexposition des brouillons ; sanitization ; unicit√© `(edition,slug)`.

---

## üé§ apps/lineup

### 1) Objectifs (incl. Roadmap)

* √ätre le **catalogue artistique** ; import/enrichissement depuis **Spotify/MusicBrainz** ;
* Calculer un **score de compatibilit√©** artiste ‚Üî sc√®ne/genre (heuristique) ;
* D√©clencher des **webhooks** lors d‚Äôajouts/mises √† jour significatives.

### 2) Exigences fonctionnelles

* `Artist.popularity` ‚àà \[0,100] ; index√©e.
* `external_ids` JSON : sch√©ma minimal (`spotify`, `musicbrainz`) ; valid√©.
* `ArtistAvailability` : `(artist,date)` unique ; `available` bool.

### 3) API

* Lecture‚Äëseule actuel (GET) ; Roadmap : POST/PUT r√©serv√©s `booker`.
* Filtres : `country` ISO2 ; `genres` (M2M) ; `popularity` (exacte, ou plage Roadmap `min_pop`/`max_pop`).

### 4) Cache & Performance

* TTL 300s pour tops popularit√©.

### 5) Observabilit√©

* `lineup_artists_total` ; `lineup_import_jobs_total{source}` (Roadmap).

### 6) Tests

* Contraintes `(artist,date)` ; validateurs `popularity` ; recherche et tri d√©terministes.

---

## üìÖ apps/schedule

### 1) Objectifs (incl. Roadmap)

* Construire un **planning sans conflits** ;
* **G√©n√©ration automatique** par templates (copie d‚Äôune √©dition N‚Äë1) ;
* **Webhooks** sur modifications (`created|updated|canceled`) ;
* Export **ICS** standard.

### 2) Exigences fonctionnelles

* `Slot` : `end_time > start_time` ; `day` ‚àà \[edition.start\_date, edition.end\_date].
* **Anti‚Äëchevauchement** (Roadmap) : sur `(stage,day)` pas de recouvrement d‚Äôhoraires ; renvoi `409 CONFLICT` avec `conflicts=[{slot_id, start, end}]`.
* `is_headliner` pour mise en avant.
* `setlist_urls` : tableau d‚ÄôURL ; validation.

### 3) API

* `GET/POST /api/schedule/slots/` ; filtres `edition,stage,artist,day,status,is_headliner` ; tri `day,start_time`.
* **ICS** : `GET /api/schedule/ics/?day=&artist=&stage=` ; timezone Europe/Paris ; each event : `SUMMARY="{artist} @ {stage}"`.

### 4) Cache & Performance

* TTL 120s pour vues `?day=`.

### 5) Observabilit√©

* `schedule_slots_status_total{status}` ; `schedule_conflicts_detected_total` (Roadmap).

### 6) Tests

* Validation horaire ; g√©n√©ration ICS ; d√©tection chevauchements (unit + int√©gration).

---

## ü§ù apps/sponsors

### 1) Objectifs (incl. Roadmap)

* G√©rer sponsors par **tier** ;
* **Contrats S3** (upload + m√©tadonn√©es) ;
* **Statistiques** (montants par tier, visibilit√©) ;
* **Webhooks** lors de nouveaux partenariats.

### 2) Exigences fonctionnelles

* `SponsorTier.rank` : entier, 1 = plus haut ; ordering par `rank`.
* `Sponsorship` : `(edition,sponsor)` unique ; `visible` bool ; `order` pour tri intra‚Äëtier.
* `logo` : URL https ; validation mimetype √† l‚Äôupload (Roadmap).

### 3) API

* CRUD sur `tiers`, `sponsors`, `sponsorships` ; filtres `edition,tier,visible` ; recherche `sponsor__name`.

### 4) Observabilit√©

* `sponsors_visible_total{tier}` ; `sponsorship_amount_sum_eur{edition}`.

### 5) Tests

* Unicit√© `(edition,sponsor)` ; tri par `tier.rank, order` ; validations URL.

---

## üéüÔ∏è apps/tickets

### 1) Objectifs (incl. Roadmap)

* D√©finir l‚Äôoffre de billets ;
* **Paliers dynamiques** (EARLY/REGULAR/LATE ‚Äì Roadmap : champ `phase`) ;
* **Quotas segment√©s** par canal (`quota_by_channel` JSON ‚Äì Roadmap) ;
* **Anti‚Äëfraude** : rate‚Äëlimit (cr√©ation de r√©servations si module vente) ;
* **Webhooks** : `tickets.type.sale_opened|sale_closed`.

### 2) Exigences fonctionnelles

* `quota_reserved ‚â§ quota_total` ; `sale_end > sale_start` si d√©finis ; `day` dans la plage de l‚Äô√©dition s‚Äôil existe.
* `is_on_sale()` : actif ET maintenant dans `[sale_start, sale_end]` si pr√©sents.
* `currency` fig√©e `EUR` (Roadmap multi‚Äëdevises si besoin).

### 3) API

* CRUD `/api/tickets/types/` ; filtres `edition,currency,is_active,day` ; tri `code,price`.

### 4) Cache & Performance

* TTL 120s pour listes publiques ¬´ en vente ¬ª. Invalidation sur update.

### 5) Observabilit√©

* `tickets_on_sale_total` ; `tickets_quota_remaining_sum` ; `tickets_sale_window_open_total`.

### 6) Tests

* Bornes `is_on_sale()` ; validations quotas/dates ; unicit√© `(edition,code)`.

---

## üö¶ Rate‚Äëlimit & anti‚Äëabus

* **Public GET** : 120 req/min/IP.
* **Authenticated GET** : 240 req/min/token.
* **Writes (POST/PUT/PATCH/DELETE)** : 60 req/min/token.
* **Webhooks** : 10 req/s endpoint avec burst 50 ; retry exponentiel (cap 24h).

## üóÉÔ∏è Migration & donn√©es

* **Politique migrations** : une migration par PR ; nom explicite ; `RunPython` pour backfill si ajout de contraintes.
* **R√©tention** : logs 30j (prod) ; audit 365j ; RGPD : suppression sur demande utilisateur (authx ‚Äì Roadmap SoftDelete + purge planifi√©e).

## üß© D√©pendances inter‚Äëapps (r√©sum√©)

* `core` ‚á¢ r√©f√©renc√© par `cms`, `schedule`, `sponsors`, `tickets`.
* `lineup` ‚á¢ r√©f√©renc√© par `schedule`.
* `common` ‚á¢ mixins utilis√©s partout.
* `authx` ‚á¢ aucune FK sortante, mais consomm√© transversalement pour pr√©f√©rences et ownership.

## ‚úÖ Crit√®res d‚Äôacceptation transverses

* 100% des endpoints respectent pagination/tri/recherche document√©s.
* Sch√©ma d‚Äôerreur uniforme partout ; `request_id` syst√©matique.
* R√¥les DRF v√©rifi√©s par tests d‚Äôautorisation.
* Cache actif sur endpoints list√©s ; invalidations test√©es.
* Couverture tests ‚â• 85%.
* Metrics Prometheus expos√©es au moins pour CMS/Schedule/Tickets/Core.

---

### Annexes (exemples requ√™tes)

**Lister les news publi√©es de l‚Äô√©dition active tri√©es par date**

```bash
curl -s \
  "/api/cms/news/?edition=2025&status=published&ordering=-publish_at&limit=10" | jq
```

**Exporter l‚ÄôICS du J2 sc√®ne Main Stage**

```bash
curl -s "/api/schedule/ics/?day=2025-07-19&stage=3" -o festival-day2.ics
```

**Cr√©er un ticket PASS1J pour J3**

```bash
curl -X POST \
  -H 'Authorization: Bearer <token>' \
  -H 'Content-Type: application/json' \
  -d '{
    "edition": 1,
    "code": "PASS1J-J3",
    "name": "Pass 1 jour ‚Äì J3",
    "day": "2025-07-20",
    "price": "69.00",
    "currency": "EUR",
    "vat_rate": "20.0",
    "quota_total": 1500,
    "quota_reserved": 0,
    "is_active": true
  }' \
  /api/tickets/types/
```
